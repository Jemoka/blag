<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Commissioner:wght@100;300;400;500;700&family=IBM+Plex+Sans:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel=stylesheet><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>window.MathJax={loader:{load:["[tex]/physics"]},tex:{packages:{"[+]":["physics"]}}}</script><title>PGA</title>
<meta name=description content="PGA extends controller gradient ascent to cover CPOMDPs
Notation Recall from controller gradient ascent we have an objective which we will modify for CPOMDPs. For initial controller-states \(\beta\) and utility \(\bold{u}_{\theta}\):
\begin{equation} \max_{\theta}\ \beta^{\top} (\bold{I} - \gamma \bold{T}_{\theta})^{-1} \bold{r}_{\theta} \end{equation}
subject to:
\(\Psi\) remains a probably distribution over \(|A|\) \(\eta\) remains a probably distribution over \(|X|\) and, new for CPOMDP, \(\beta^{\top} (\bold{I} - \gamma \bold{T}_{\theta})^{-1} C_{i} \leq \epsilon_{i}\ \forall i\), that is, each constraint \(C_{i} \in \bold{C}_{i}\) is satisfied to be lower than the budget \(\epsilon_{i}\)."><meta name=author content="Houjun Liu"><link rel=stylesheet href=/css/global.css><link rel=stylesheet href=/css/syntax.css></head><body><div class=center-clearfix><header><span id=header-name onclick='window.location.href="/"' style=cursor:pointer>Houjun Liu</span><div id=socialpanel><a href=https://www.jemoka.com/search/ class=header-social id=header-search><i class="ic fa-solid fa-magnifying-glass"></i></i></a>
<a href=https://github.com/Jemoka/ class=header-social id=header-github><i class="ic fa-brands fa-github"></i></a>
<a href=https://maly.io/@jemoka class=header-social id=header-twitter><i class="ic fa-brands fa-mastodon"></i></a>
<a href=https://www.reddit.com/user/Jemoka/ class=header-social id=header-reddit><i class="ic fa-brands fa-reddit"></i></a></div></header><div id=title><h1>PGA</h1><span class=tagbox></span></div><aside id=toc><h1 id=toc-title>table of contents</h1><nav id=TableOfContents><ul><li><a href=#notation>Notation</a></li><li><a href=#optimization-formulation>Optimization Formulation</a></li><li><a href=#exact-gradient-ascent>Exact Gradient Ascent</a><ul><li><a href=#golden-section-line-search>Golden Section Line Search</a></li></ul></li><li><a href=#approximate-solution>Approximate Solution</a></li><li><a href=#d41d8c></a></li></ul></nav></aside><main><article><div><p><a href=/posts/kbhpga/>PGA</a> extends <a href=/posts/kbhcontroller_gradient_ascent/>controller gradient ascent</a> to cover <a href=/posts/kbhcpomdp/>CPOMDPs</a></p><h2 id=notation>Notation</h2><p>Recall from <a href=/posts/kbhcontroller_gradient_ascent/>controller gradient ascent</a> we have an objective which we will modify for <a href=/posts/kbhcpomdp/>CPOMDP</a>s. For initial controller-states \(\beta\) and utility \(\bold{u}_{\theta}\):</p><p>\begin{equation}
\max_{\theta}\ \beta^{\top} (\bold{I} - \gamma \bold{T}_{\theta})^{-1} \bold{r}_{\theta}
\end{equation}</p><p>subject to:</p><ul><li>\(\Psi\) remains a probably distribution over \(|A|\)</li><li>\(\eta\) remains a probably distribution over \(|X|\)</li><li>and, new for <a href=/posts/kbhcpomdp/>CPOMDP</a>, \(\beta^{\top} (\bold{I} - \gamma \bold{T}_{\theta})^{-1} C_{i} \leq \epsilon_{i}\ \forall i\), that is, each constraint \(C_{i} \in \bold{C}_{i}\) is satisfied to be lower than the budget \(\epsilon_{i}\).</li></ul><p>where</p><p>\begin{equation}
T_{\theta}((x,s), (x&rsquo;,s&rsquo;)) = \sum_{a} \Psi(a | x) T(s&rsquo;|s,a) \sum_{o} O (o|a,s&rsquo;) \eta (x&rsquo;|x,a,o)
\end{equation}</p><p>and</p><p>\begin{equation}
R_{\theta}((x, s)) = \sum_{a} \Psi(a|x) R(s,a)
\end{equation}</p><p>in which</p><ul><li>\(X\): a set of nodes (hidden, internal states)</li><li>\(\Psi(a|x)\): probability of taking an action</li><li>\(\eta(x&rsquo;|x,a,o)\) : transition probability between hidden states</li></ul><h2 id=optimization-formulation>Optimization Formulation</h2><p>For ease of notation in constructing this result, we declare:</p><p>\begin{equation}
f(\theta) = \beta^{\top} (\bold{I} - \gamma \bold{T}_{\theta})^{-1} \bold{r}_{\theta}
\end{equation}</p><p>and</p><p>\begin{equation}
h_{i}(\theta) = \beta^{\top} (\bold{I} - \gamma \bold{T}_{\theta})^{-1} C_{i}
\end{equation}</p><p>we formulate policy parameters \(\theta\) as a large stacked vector of the shape:</p><p>\begin{equation}
\theta = \mqty(\Psi(a_0 | x_0) \\ \Psi(a_1 | x_0) \\ \dots \\ \Psi(a_n | x_N) \\ \eta(x_0 | x_0, a_0, o_0) \\ \eta(x_1 | x_0, a_0, o_0) \\ \dots \\ \eta(x_N | x_N, a_n, o_f))
\end{equation}</p><p>Let us define block diagonal matricies \(J_{\Psi}\) and \(J_{\eta}\), whereby:</p><p>\begin{equation}
J_{\Psi} = \mqty(\bold{1}_{\Psi}^{\top} & \dots & \bold{0} \\ & \dots & \\ \bold{0} & \dots &\bold{1}_{\Psi}^{\top} )
\end{equation}</p><p>where \(J_{\Psi} \in \mathbb{R}^{|X| \times (|A| \times |X|)}\) and each block part \(\bold{1}_{\Psi} \in \mathbb{R}^{|A|}\) represents a one-vector of length of the action space. You can see how multiplying a vector \(\qty[\Psi(a_0|x_0) \\ \dots \\ \Psi(a_n|x_N)]\) against this matrix should yield a \(1\) vector if each \(\Psi(\cdot | x_{i})\) is a probability distribution.</p><p>Similar, we define, \(J_{\eta}\) in a similar fashion to add the distributions over each \(\eta(\cdot | x, a, o)\).</p><p>This yields another block-block matrix</p><p>\begin{equation}
J = \mqty(J_{\Psi} & 0 \\ 0 & J_{\eta})
\end{equation}</p><p>for which we desire \(J\theta = 1\) in order to verify that the probability distributions are valid.</p><p>Lastly, let us define \(\bold{Z} = (\bold{I} - \gamma \bold{T}_{\theta})\)</p><p>Finally, this allows us to formulate the problem as a nonlinear optimization problem:</p><p>\begin{align}
\max_{\theta}\ &amp;f(\theta) \\
\text{such that}\ &amp;J\theta = 1 \\
& \theta \geq 0 \\
& h_{i}(\theta) &lt; \epsilon_{i},\ \forall i
\end{align}</p><h2 id=exact-gradient-ascent>Exact Gradient Ascent</h2><p>Note that the initial state information \(\beta\) is constant. Therefore, the gradient of the top expression against each field in \(\theta\) becomes, via an rearrangement of the chain rule:</p><p>\begin{equation}
\pdv{f(\theta)}{\theta_{i}} = \beta^{\top} \qty[\bold{Z}^{-1} \qty( \pdv{\bold{r}_{\theta}}{\theta_{i}} + \pdv{\bold{Z}}{\theta_{i}} \bold{Z}^{-1}\bold{r}_{\theta})]
\end{equation}</p><p>The derivatives of each \(\theta\) against each \(\bold{r}\) and \(\bold{Z}\) is given on pp 485 of Alg4DM.</p><p>As with all gradient ascent cases, each &ldquo;step&rdquo; takes the rough form of</p><p>\begin{equation}
\xi = \theta + \alpha \nabla_{\theta} f(\theta)
\end{equation}</p><p>however, in this implementation, the step size isn&rsquo;t actually fixed. Instead, we do&mldr;</p><h3 id=golden-section-line-search>Golden Section Line Search</h3><p>Instead of taking fixed-step sizes to get to the maxima, <a href=/posts/kbhpga/>PGA</a> proposes <a href=#golden-section-line-search>Golden Section Line Search</a> as a line-search algorithm to dynamically choose the steps to get to maxima.</p><p>Line search algorithms are typically computationally heavy as it requires evaluating the relative utility (i.e. here \(\bold{Z}^{-1} \bold{r}_{\theta}\)) a lot of times, which is computationally intractable.</p><p>So, <a href=#golden-section-line-search>Golden Section Line Search</a> uses a divide-and-conquer method via the golden ratio to address this issue.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>optimize</span><span style=color:#960050;background-color:#1e0010>!</span><span style=color:#111>(</span><span style=color:#111>CPOMDP</span><span style=color:#111>,</span> <span style=color:#111>phi</span><span style=color:#f92672>=</span><span style=color:#111>golden_ratio</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>              <span style=color:#111>gamma</span><span style=color:#f92672>=</span><span style=color:#111>discount_factor</span><span style=color:#111>,</span> <span style=color:#111>eps</span><span style=color:#f92672>=</span><span style=color:#111>minimum_boundary</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># C-POMDP Spec</span>
</span></span><span style=display:flex><span>    <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>CPOMDP</span><span style=color:#f92672>.</span><span style=color:#111>objective_function</span> <span style=color:#75715e># this is f(theta)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>T</span> <span style=color:#f92672>=</span> <span style=color:#111>CPOMDP</span><span style=color:#f92672>.</span><span style=color:#111>transition_matrix</span>
</span></span><span style=display:flex><span>    <span style=color:#111>R</span> <span style=color:#f92672>=</span> <span style=color:#111>CPOMDP</span><span style=color:#f92672>.</span><span style=color:#111>reward_vector</span>
</span></span><span style=display:flex><span>    <span style=color:#111>b</span> <span style=color:#f92672>=</span> <span style=color:#111>CPOMDP</span><span style=color:#f92672>.</span><span style=color:#111>initial_state_vector</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># as obtained above</span>
</span></span><span style=display:flex><span>    <span style=color:#111>nabla</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>grad</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># initialize the search bounds based on splitting</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># search space (full step, no step) via the golden ratio</span>
</span></span><span style=display:flex><span>    <span style=color:#111>a1</span><span style=color:#111>,</span> <span style=color:#111>a2</span><span style=color:#111>,</span> <span style=color:#111>a3</span><span style=color:#111>,</span> <span style=color:#111>a4</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#111>phi</span><span style=color:#111>)),</span> <span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#111>phi</span><span style=color:#111>),</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># calculate new policies and their utilities</span>
</span></span><span style=display:flex><span>    <span style=color:#111>theta2</span><span style=color:#111>,</span> <span style=color:#111>theta3</span> <span style=color:#f92672>=</span> <span style=color:#111>theta</span> <span style=color:#f92672>+</span> <span style=color:#111>a2</span><span style=color:#f92672>*</span><span style=color:#111>nabla</span><span style=color:#111>,</span> <span style=color:#111>theta</span> <span style=color:#f92672>+</span> <span style=color:#111>a3</span><span style=color:#f92672>*</span><span style=color:#111>nabla</span>
</span></span><span style=display:flex><span>    <span style=color:#111>z2</span><span style=color:#111>,</span> <span style=color:#111>z3</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>I</span><span style=color:#f92672>-</span><span style=color:#111>gamma</span><span style=color:#f92672>*</span><span style=color:#111>T</span><span style=color:#75af00>@theta2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>inverse</span><span style=color:#111>(),</span> <span style=color:#111>(</span><span style=color:#111>I</span><span style=color:#f92672>-</span><span style=color:#111>gamma</span><span style=color:#f92672>*</span><span style=color:#111>T</span><span style=color:#75af00>@theta3</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>inverse</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># search until the middle bounds converged</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span> <span style=color:#111>(</span><span style=color:#111>a4</span><span style=color:#f92672>-</span><span style=color:#111>a1</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>eps</span><span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#111>abs</span><span style=color:#111>(</span><span style=color:#111>a2</span><span style=color:#111>)</span> <span style=color:#f92672>+</span> <span style=color:#111>abs</span><span style=color:#111>(</span><span style=color:#111>a3</span><span style=color:#111>)):</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># calculate utility vectors over belief</span>
</span></span><span style=display:flex><span>        <span style=color:#111>u2</span><span style=color:#111>,</span> <span style=color:#111>u3</span> <span style=color:#f92672>=</span> <span style=color:#111>z2</span><span style=color:#75af00>@R</span><span style=color:#111>,</span> <span style=color:#111>z3</span><span style=color:#75af00>@R</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># either relax top or bottom bounds, depending on</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># which one we had been successfully maximizing</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>b</span><span style=color:#f92672>.</span><span style=color:#111>dot</span><span style=color:#111>(</span><span style=color:#111>u3</span><span style=color:#111>)</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>b</span><span style=color:#f92672>.</span><span style=color:#111>dot</span><span style=color:#111>(</span><span style=color:#111>u2</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># search &#34;upwards&#34;, set bottom bound to a3</span>
</span></span><span style=display:flex><span>            <span style=color:#111>a1</span><span style=color:#111>,</span> <span style=color:#111>a2</span><span style=color:#111>,</span> <span style=color:#111>a3</span> <span style=color:#f92672>=</span> <span style=color:#111>a2</span><span style=color:#111>,</span> <span style=color:#111>a3</span><span style=color:#111>,</span> <span style=color:#111>a2</span><span style=color:#f92672>+</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#111>phi</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#111>a4</span><span style=color:#f92672>-</span><span style=color:#111>a2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>theta3</span><span style=color:#111>,</span> <span style=color:#111>theta2</span> <span style=color:#f92672>=</span> <span style=color:#111>theta</span> <span style=color:#f92672>+</span> <span style=color:#111>a3</span><span style=color:#f92672>*</span><span style=color:#111>nabla</span><span style=color:#111>,</span> <span style=color:#111>theta3</span>
</span></span><span style=display:flex><span>            <span style=color:#111>z3</span><span style=color:#111>,</span> <span style=color:#111>z2</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>I</span><span style=color:#f92672>-</span><span style=color:#111>gamma</span><span style=color:#f92672>*</span><span style=color:#111>T</span><span style=color:#75af00>@theta2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>inverse</span><span style=color:#111>(),</span> <span style=color:#111>z3</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># search &#34;downwards&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>a1</span><span style=color:#111>,</span> <span style=color:#111>a3</span><span style=color:#111>,</span> <span style=color:#111>a2</span> <span style=color:#f92672>=</span> <span style=color:#111>a2</span><span style=color:#111>,</span> <span style=color:#111>a2</span><span style=color:#111>,</span> <span style=color:#111>a3</span><span style=color:#f92672>-</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#111>phi</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#111>a3</span><span style=color:#f92672>-</span><span style=color:#111>a1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>theta2</span><span style=color:#111>,</span> <span style=color:#111>theta3</span> <span style=color:#f92672>=</span> <span style=color:#111>theta</span> <span style=color:#f92672>+</span> <span style=color:#111>a2</span><span style=color:#f92672>*</span><span style=color:#111>nabla</span><span style=color:#111>,</span> <span style=color:#111>theta2</span>
</span></span><span style=display:flex><span>            <span style=color:#111>z2</span><span style=color:#111>,</span> <span style=color:#111>z3</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>I</span><span style=color:#f92672>-</span><span style=color:#111>gamma</span><span style=color:#f92672>*</span><span style=color:#111>T</span><span style=color:#75af00>@theta2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>inverse</span><span style=color:#111>(),</span> <span style=color:#111>z2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># return the average of our converged results</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0.5</span><span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#111>theta2</span><span style=color:#f92672>+</span><span style=color:#111>theta3</span><span style=color:#111>),</span> <span style=color:#ae81ff>0.5</span><span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#111>u2</span><span style=color:#f92672>+</span><span style=color:#111>u3</span><span style=color:#111>)</span>
</span></span></code></pre></div><h2 id=approximate-solution>Approximate Solution</h2><h2 id=d41d8c></h2></div></article></main><footer><p id=footer>&copy; 2019-2024 Houjun Liu. Licensed CC BY-NC-SA 4.0.</p></footer></div></body></html>