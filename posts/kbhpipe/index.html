<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Commissioner:wght@100;300;400;500;700&family=IBM+Plex+Sans:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100;0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel=stylesheet><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>window.MathJax={loader:{load:["[tex]/physics"]},tex:{packages:{"[+]":["physics"]}}}</script><title>pipe</title><meta name=description content="pipe chains the STDOUT of one command and put it to the STDIN of another command. Typically, we want to do pipe per direction.
command pipelines

span two child processes
create a pipe to allow the two processes to communicate
connect the first child&rsquo;s STDOUT to the pipe + the second child&rsquo;s STDIN to the pipe

pipe()
pipe() gives us back two file descriptors, such that whatever is written to one can be read from another."><meta name=author content="Houjun Liu"><link rel=stylesheet href=/css/global.css><link rel=stylesheet href=/css/syntax.css></head><body><div class=center-clearfix><header><span id=header-name onclick='window.location.href="/"' style=cursor:pointer>Houjun Liu</span><div id=socialpanel><a href=https://www.jemoka.com/search/ class=header-social id=header-search><i class="ic fa-solid fa-magnifying-glass"></i></i></a>
<a href=https://github.com/Jemoka/ class=header-social id=header-github><i class="ic fa-brands fa-github"></i></a>
<a href=https://maly.io/@jemoka class=header-social id=header-twitter><i class="ic fa-brands fa-mastodon"></i></a>
<a href=https://www.reddit.com/user/Jemoka/ class=header-social id=header-reddit><i class="ic fa-brands fa-reddit"></i></a></div></header><div id=title><h1>pipe</h1><span class=tagbox></span></div><aside id=toc><h1 id=toc-title>table of contents</h1><nav id=TableOfContents><ul><li><a href=#command-pipelines>command pipelines</a></li><li><a href=#pipe>pipe()</a></li><li><a href=#dup2>dup2()</a></li><li><a href=#stalling>stalling</a></li></ul></nav></aside><main><article><div><p><a href=/posts/kbhpipe/>pipe</a> chains the STDOUT of one command and put it to the STDIN of another command. Typically, we want to do pipe per direction.</p><h2 id=command-pipelines>command pipelines</h2><ol><li>span two child processes</li><li>create a pipe to allow the two processes to communicate</li><li>connect the first child&rsquo;s STDOUT to the pipe + the second child&rsquo;s STDIN to the pipe</li></ol><h2 id=pipe>pipe()</h2><p><a href=#pipe>pipe()</a> gives us back two <a href=/posts/kbhsyscalls/#file-descriptor>file descriptor</a>s, such that whatever is written to one can be read from another.</p><p>Interface:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#111>pipes</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// create the pipes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>int</span> <span style=color:#111>ret</span> <span style=color:#f92672>=</span> <span style=color:#75af00>pipe</span><span style=color:#111>(</span><span style=color:#111>pipes</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// an so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>int</span> <span style=color:#111>read_from_here</span> <span style=color:#f92672>=</span> <span style=color:#111>ret</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#111>write_to_here</span> <span style=color:#f92672>=</span> <span style=color:#111>ret</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// i.e. ret[1] writes to =&gt; ret[0] read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// fork!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>pid_t</span> <span style=color:#111>pid_p</span> <span style=color:#f92672>=</span> <span style=color:#75af00>fork</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#111>pid_p</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// child subroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// because child is READING, and not READINg
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// we want to close the write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>write_to_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// we want to then make a buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>char</span> <span style=color:#111>buf</span><span style=color:#111>[</span><span style=color:#111>num_bytes</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// if the child reads before the parents write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// it will block until some data is available
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// if the write ends are closed globally, read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// will also stop.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#111>read_from_here</span><span style=color:#111>,</span> <span style=color:#111>buffer</span><span style=color:#111>,</span> <span style=color:#00a8c8>sizeof</span><span style=color:#111>(</span><span style=color:#111>buffer</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>read_from_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// parent subroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e>// because parent is WRITING and not READING
</span></span></span><span style=display:flex><span><span style=color:#75715e>// we don&#39;t want the read to block, we will
</span></span></span><span style=display:flex><span><span style=color:#75715e>// close the parent immediately.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>read_from_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// write some data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>write</span><span style=color:#111>(</span><span style=color:#111>write_to_here</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;msg&#34;</span><span style=color:#111>,</span> <span style=color:#111>num_bytes</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// close now we are done writing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>write_to_here</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// clean up child
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>waitpid</span><span style=color:#111>(</span><span style=color:#111>pid_p</span><span style=color:#111>,</span> <span style=color:#111>NULL</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>);</span>
</span></span></code></pre></div><p><a href=/posts/kbhpipe/>pipe</a>s have to be closed twice, and opened before the fork.</p><h2 id=dup2>dup2()</h2><p><a href=#dup2>dup2()</a> lets you <strong>REWIRE</strong> fire descriptors:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75af00>dup2</span><span style=color:#111>(</span><span style=color:#111>scrfd</span><span style=color:#111>,</span> <span style=color:#111>destft</span><span style=color:#111>);</span>
</span></span></code></pre></div><p>for instance:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75af00>dup2</span><span style=color:#111>(</span><span style=color:#111>fds</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>STDIN_FILENO</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>close</span><span style=color:#111>(</span><span style=color:#111>fds</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]);</span>
</span></span></code></pre></div><p>copy the underlying open file pointer which <code>fds[0]</code> points to the FD STDIN, meaning STDIN will now refer to the underlying file of <code>fds[0]</code>.</p><h2 id=stalling>stalling</h2><p>if you <strong>don&rsquo;t close the right ends of your pipes, it STALLS</strong>. <code>read()</code> BLOCKS UNTIL ALL WRITES ARE CLOSED!</p></div></article></main><footer><p id=footer>&copy; 2019-2024 Houjun Liu. Licensed CC BY-NC-SA 4.0.</p></footer></div></body></html>